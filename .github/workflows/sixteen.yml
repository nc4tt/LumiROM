name: LumiROM Tools

on:
  workflow_dispatch:
    inputs:
      STOCK_DEVICE:
        description: "STOCK_DEVICE_MODEL."
        required: true
        default: "SM-A325F"
      TARGET_DEVICE:
        description: "TARGET_DEVICE_MODEL."
        required: true
        default: "SM-A346E"
      TARGET_DEVICE_CSC:
        description: "TARGET_DEVICE_CSC."
        required: true
        default: "INS"
      TARGET_DEVICE_IMEI:
        description: "TARGET_DEVICE_IMEI."
        required: true
        default: "353435774197736"
      OUTPUT_FILESYSTEM:
        description: "OUTPUT_FILESYSTEM. e.g erofs / ext4"
        required: true
        default: "erofs"

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Cleaning junk files
        uses: rokibhasansagar/slimhub_actions@v25.42.5

      - name: Installing required packages.
        run: |
          sudo apt install -y p7zip-full lz4 android-sdk-libsparse-utils python3 python3-pip zipalign unzip e2fsprogs default-jre openjdk-17-jdk  >/dev/null 2>&1
          pip3 install liblp tgcrypto pyrogram  >/dev/null 2>&1
          pip3 install git+https://github.com/martinetd/samloader.git  >/dev/null 2>&1
          # Binary
          chmod +x "$(pwd)/bin/ext4/make_ext4fs"
          chmod +x "$(pwd)/bin/erofs-utils/extract.erofs"
          chmod +x "$(pwd)/bin/erofs-utils/mkfs.erofs"

      - name: Setup directories.
        run: |
          chmod +x ./scripts/setup_directories.sh
          bash ./scripts/setup_directories.sh FIRMWARE WORK OUT

      - name: Make Rom.
        run: |
          chmod +x ./sixteen.sh
          bash ./sixteen.sh ${{ github.event.inputs.STOCK_DEVICE }} ${{ github.event.inputs.TARGET_DEVICE }} ${{ github.event.inputs.TARGET_DEVICE_CSC }} ${{ github.event.inputs.TARGET_DEVICE_IMEI }} ${{ github.event.inputs.OUTPUT_FILESYSTEM }}

      - name: Splitting files before uploading if need.
        run: |
          GIT_SUPPORT_SIZE=2147483647
          OUT_DIR="./OUT"
          echo "BUILD_TIME=$(date '+%Y-%m-%d %I:%M:%S %p UTC')" >> $GITHUB_ENV
          echo "--- Checking for large files in $OUT_DIR ---"

          for file in "$OUT_DIR"/*; do
            [ -f "$file" ] || continue
            FILE_SIZE=$(stat -c%s "$file")
            if [ "$FILE_SIZE" -gt "$GIT_SUPPORT_SIZE" ]; then
              echo "üì¶ Splitting: $file (Size: $FILE_SIZE bytes)"
              split -b "$GIT_SUPPORT_SIZE" -d -a 3 "$file" "$file.part"
              rm -f "$file"
            fi
          done

      - name: Uploading all files to GitHub Release.
        uses: softprops/action-gh-release@v2
        with:
          tag_name: "build-${{ github.run_id }}"
          name: "${{ github.event.inputs.TARGET_DEVICE }} On ${{ github.event.inputs.STOCK_DEVICE }} LumiROM Build: ${{ github.run_id }}"
          body: |
            ***Build Information***
            - ‚û°Ô∏è Build For: ${{ github.event.inputs.STOCK_DEVICE }}
            - ‚û°Ô∏è Build From: ${{ GITHUB.EVENT.INPUTS.TARGET_DEVICE }}
            - ‚è∞Ô∏è Build Time: ${{ env.BUILD_TIME }}
          files: |
            ./OUT/*
        env:
          GITHUB_TOKEN: ${{ secrets.GIT_TOKEN }}

      - name: Cleaning everything.
        run: |
          rm -rf *
